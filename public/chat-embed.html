<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>theacademy - Chat + Referencia</title>
    <link rel="stylesheet" href="/style.css" />
    <script src="/socket.io/socket.io.js"></script>
  </head>
  <body class="embed-view">
    <div class="split-layout">
      <aside class="reference-pane">
        <header class="reference-header">
          <h2>Referencia externa</h2>
          <p>Consulta el contenido de ejemplo.com mientras conversas con el cajero.</p>
        </header>
<iframe
  src="/embed/ganamos"
  width="100%"
  height="600"
  style="border:none;"
  loading="lazy">
</iframe>
      </aside>
    </div>

    <div class="floating-chat" role="region" aria-label="Chat con cajero">
      <header class="chat-header">
        <div class="chat-contact">
          <div class="avatar" aria-hidden="true">ðŸ’¬</div>
          <div>
            <h2>Cajero virtual</h2>
            <p id="chatStatus" class="status-pill status-offline">Conectando...</p>
          </div>
        </div>
      </header>

      <div class="chat-body">
        <div id="messages" class="messages" role="log" aria-live="polite">
          <div class="empty-state">
            <div class="empty-icon">ðŸ’¡</div>
            <p>Escribe tu primer mensaje y recibe asistencia inmediata.</p>
          </div>
        </div>
      </div>

      <form id="chatForm" class="chat-form" autocomplete="off">
        <label class="sr-only" for="messageInput">Escribe un mensaje</label>
        <input
          id="messageInput"
          name="mensaje"
          placeholder="Escribe un mensaje"
          autocomplete="off"
          required
        />
        <button class="primary-button" type="submit">Enviar</button>
      </form>

      <div id="alerts" class="alerts" role="status" aria-live="polite"></div>
    </div>

    <script>
      const socket = io();
      const alerts = document.getElementById("alerts");
      const statusPill = document.getElementById("chatStatus");
      const messages = document.getElementById("messages");

      const sessionId = (() => {
        if (typeof crypto !== "undefined" && crypto.randomUUID) {
          return `embed-${crypto.randomUUID()}`;
        }
        return `embed-${Date.now().toString(36)}-${Math.floor(Math.random() * 1_000_000)}`;
      })();

      function showAlert(message, type = "info") {
        const alert = document.createElement("div");
        alert.className = `alert alert-${type}`;
        alert.textContent = message;
        alerts.appendChild(alert);
        setTimeout(() => alert.remove(), 4000);
      }

      function setStatus(text, variant) {
        statusPill.textContent = text;
        statusPill.classList.remove("status-online", "status-offline");
        statusPill.classList.add(variant);
      }

      socket.on("connect", () => {
        socket.emit("registrarTelefono", sessionId);
        setStatus("Conectado", "status-online");
      });

      socket.on("disconnect", () => {
        setStatus("Desconectado", "status-offline");
      });

      document.getElementById("chatForm").addEventListener("submit", async (e) => {
        e.preventDefault();

        const input = document.getElementById("messageInput");
        const mensaje = input.value.trim();
        if (!mensaje) return;

        agregarMensaje("TÃº", mensaje);

        try {
          const res = await fetch("/api/mensaje", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ mensaje, telefono: sessionId }),
          });

          if (!res.ok) {
            showAlert("No se pudo enviar el mensaje", "error");
          }
        } catch (error) {
          showAlert("No se pudo enviar el mensaje", "error");
        }

        input.value = "";
      });

      socket.on("mensaje", ({ autor, texto, telefono }) => {
        if (telefono !== sessionId) return;
        agregarMensaje(autor || "Cajero", texto);
      });

      function agregarMensaje(autor, texto) {
        const empty = messages.querySelector(".empty-state");
        if (empty) empty.remove();

        const row = document.createElement("div");
        row.className = `message-row ${autor === "TÃº" ? "sent" : "received"}`;

        const bubble = document.createElement("div");
        bubble.className = `bubble ${autor === "TÃº" ? "bubble-user" : "bubble-agent"}`;

        const authorEl = document.createElement("span");
        authorEl.className = "bubble-author";
        authorEl.textContent = autor;

        const textEl = document.createElement("p");
        textEl.className = "bubble-text";
        textEl.textContent = texto;

        bubble.appendChild(authorEl);
        bubble.appendChild(textEl);
        row.appendChild(bubble);
        messages.appendChild(row);
        messages.scrollTop = messages.scrollHeight;
      }
    </script>
  </body>
</html>
