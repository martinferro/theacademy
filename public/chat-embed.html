<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>theacademy - Chat + Referencia</title>
    <link rel="stylesheet" href="/style.css" />
    <script src="/socket.io/socket.io.js"></script>
  </head>
  <body class="embed-view">
    <div class="split-layout">
      <div class="chat-pane">
        <main class="app-shell">
          <aside class="onboarding" id="authSection">
            <header class="brand">
              <div class="logo-circle">ta</div>
              <div>
                <h1>theacademy</h1>
                <p class="subtitle">Tu canal directo con el cajero.</p>
              </div>
            </header>

            <section class="steps">
              <h2>Verificación rápida</h2>
              <ol class="stepper">
                <li class="stepper-item">
                  <span class="stepper-number">1</span>
                  <div>
                    <h3>Comparte tu número</h3>
                    <p>Ingresa tu celular para enviarte un SMS de validación.</p>
                  </div>
                </li>
                <li class="stepper-item">
                  <span class="stepper-number">2</span>
                  <div>
                    <h3>Confirma el código</h3>
                    <p>Escribe los 6 dígitos recibidos para desbloquear el chat.</p>
                  </div>
                </li>
                <li class="stepper-item">
                  <span class="stepper-number">3</span>
                  <div>
                    <h3>Conversa al instante</h3>
                    <p>Habla con nuestro equipo en un entorno seguro.</p>
                  </div>
                </li>
              </ol>
            </section>

            <form id="phoneForm" class="form-block" autocomplete="off">
              <label for="phoneInput">Número de teléfono</label>
              <div class="input-group">
                <span class="input-prefix">📱</span>
                <input
                  id="phoneInput"
                  name="phone"
                  type="tel"
                  inputmode="tel"
                  placeholder="Ej. +5491124098501"
                  required
                />
              </div>
              <p class="help">Recibirás un SMS con un código de 6 dígitos.</p>
              <button class="primary-button" type="submit">Enviar código</button>
            </form>

            <form id="codeForm" class="form-block" hidden autocomplete="one-time-code">
              <label for="codeInput">Código de verificación</label>
              <div class="input-group">
                <span class="input-prefix">🔐</span>
                <input
                  id="codeInput"
                  name="code"
                  type="text"
                  inputmode="numeric"
                  pattern="\d{6}"
                  maxlength="6"
                  placeholder="Ingresa los 6 dígitos"
                  required
                />
              </div>
              <p class="help">Revisa tu SMS e ingresa el código recibido.</p>
              <div class="form-actions">
                <button class="secondary-button" type="button" id="resendButton">Reenviar código</button>
                <button class="primary-button" type="submit">Validar código</button>
              </div>
            </form>
          </aside>

          <section id="chatSection" class="chat" hidden>
            <header class="chat-header">
              <div class="chat-contact">
                <div class="avatar" aria-hidden="true">💬</div>
                <div>
                  <h2>Cajero virtual</h2>
                  <p id="verifiedPhone" class="verified"></p>
                </div>
              </div>
              <button class="secondary-button" id="logoutButton" type="button">Cerrar sesión</button>
            </header>

            <div class="chat-body">
              <div id="messages" class="messages" role="log" aria-live="polite">
                <div class="empty-state">
                  <div class="empty-icon">💡</div>
                  <p>Escribe tu primer mensaje y recibe asistencia inmediata.</p>
                </div>
              </div>
            </div>

            <form id="chatForm" class="chat-form" autocomplete="off">
              <input
                id="messageInput"
                name="mensaje"
                placeholder="Escribe un mensaje"
                autocomplete="off"
                required
              />
              <button class="primary-button" type="submit">Enviar</button>
            </form>
          </section>
        </main>

        <div id="alerts" class="alerts" role="status" aria-live="polite"></div>
      </div>

      <aside class="reference-pane">
        <header class="reference-header">
          <h2>Referencia externa</h2>
          <p>Consulta el contenido de ejemplo.com mientras conversas con el cajero.</p>
        </header>
        <div class="reference-frame">
          <iframe src="https://ejemplo.com" title="Referencia externa" allowfullscreen></iframe>
        </div>
      </aside>
    </div>

    <script>
      const socket = io();
      let telefonoVerificado = null;

      const phoneForm = document.getElementById("phoneForm");
      const codeForm = document.getElementById("codeForm");
      const resendButton = document.getElementById("resendButton");
      const chatSection = document.getElementById("chatSection");
      const alerts = document.getElementById("alerts");
      const logoutButton = document.getElementById("logoutButton");

      function showAlert(message, type = "info") {
        const alert = document.createElement("div");
        alert.className = `alert ${type}`;
        alert.textContent = message;
        alerts.appendChild(alert);
        setTimeout(() => alert.remove(), 4000);
      }

      phoneForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const phone = document.getElementById("phoneInput").value.trim();
        if (!phone) return showAlert("Ingresa un teléfono válido", "error");

        try {
          const res = await fetch("/api/auth/request-code", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ phone }),
          });

          const data = await res.json();
          if (data.ok) {
            showAlert("Código enviado por SMS", "success");
            phoneForm.hidden = true;
            codeForm.hidden = false;
            codeForm.dataset.phone = phone;
            document.getElementById("codeInput").focus();
          } else {
            showAlert(data.error || "No se pudo enviar el código", "error");
          }
        } catch (error) {
          showAlert("No se pudo enviar el código", "error");
        }
      });

      resendButton.addEventListener("click", async () => {
        const phone = codeForm.dataset.phone || document.getElementById("phoneInput").value.trim();
        if (!phone) return showAlert("Ingresa un teléfono válido antes de reenviar el código", "error");

        resendButton.disabled = true;
        try {
          const res = await fetch("/api/auth/request-code", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ phone }),
          });

          const data = await res.json();
          showAlert(data.ok ? "Nuevo código enviado" : "No se pudo reenviar el código", data.ok ? "success" : "error");
        } catch (error) {
          showAlert("No se pudo reenviar el código", "error");
        } finally {
          resendButton.disabled = false;
        }
      });

      codeForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const code = document.getElementById("codeInput").value.trim();
        const phone = codeForm.dataset.phone;

        try {
          const res = await fetch("/api/auth/verify-code", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ phone, code }),
          });

          const data = await res.json();
          if (data.ok) {
            telefonoVerificado = phone;
            socket.emit("registrarTelefono", phone);
            document.getElementById("verifiedPhone").textContent = `Teléfono verificado: ${phone}`;
            document.getElementById("authSection").hidden = true;
            chatSection.hidden = false;
            showAlert("¡Teléfono verificado! Ya puedes chatear.", "success");
          } else {
            showAlert(data.error || "Código incorrecto", "error");
          }
        } catch (error) {
          showAlert("No se pudo verificar el código", "error");
        }
      });

      logoutButton.addEventListener("click", () => {
        telefonoVerificado = null;
        document.getElementById("authSection").hidden = false;
        chatSection.hidden = true;
        codeForm.hidden = true;
        phoneForm.hidden = false;
        phoneForm.reset();
        codeForm.reset();
        document.getElementById("messages").innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">💡</div>
            <p>Escribe tu primer mensaje y recibe asistencia inmediata.</p>
          </div>
        `;
        showAlert("Sesión cerrada", "info");
      });

      document.getElementById("chatForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        if (!telefonoVerificado) {
          return showAlert("Verifica tu teléfono antes de enviar mensajes", "error");
        }

        const input = document.getElementById("messageInput");
        const mensaje = input.value.trim();
        if (!mensaje) return;

        agregarMensaje("Tú", mensaje);

        try {
          await fetch("/api/mensaje", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ mensaje, telefono: telefonoVerificado }),
          });
        } catch (error) {
          showAlert("No se pudo enviar el mensaje", "error");
        }

        input.value = "";
      });

      socket.on("mensaje", ({ autor, texto }) => {
        agregarMensaje(autor, texto);
      });

      function agregarMensaje(autor, texto) {
        const chat = document.getElementById("messages");
        const empty = chat.querySelector(".empty-state");
        if (empty) empty.remove();

        const msg = document.createElement("div");
        msg.className = autor === "Tú" ? "msg-user" : "msg-bot";
        msg.textContent = `${autor}: ${texto}`;
        chat.appendChild(msg);
        chat.scrollTop = chat.scrollHeight;
      }
    </script>
  </body>
</html>
